<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<script type="text/javascript" src="/scripts/json2.js"></script>
	<script type="text/javascript" src="/scripts/jsonrpc.js"></script>
	<title>Chat Room</title>
</head>
<body>
<h1>Chat room</h1>
<script type="text/javascript">
	var message_count = 0;
	var rpc = new JsonRPC('/rpc',['get'],['post']);
	function on_new_data_read(messages)
	{
	}
	function on_error(e)
	{
		document.GetElementById('error_message').innerHTML = e;
		document.GetElementById('reconnect').disabled = false;
	}
	function post_failed(e)
	{
		document.GetElementById('error_message').innerHTML = e;
	}

	rpc.get.on_result = function(messages) {
		var messagesHtml = document.GetElementById('messages');
		for(message in messages) {
			messagesHtml.innerHTML+='<dt>' + message.author +'</dt>' +
				'<dd>' + message.message + '</dd>'
			message_count++;
		}
		restart();
	}

	rpc.get.on_error = function(e) {
		document.GetElementById('error_message').innerHTML = e;
		document.GetElementById('reconnect').disabled = false;
	}
 
	rpc.post.on_error = function(e) {
		document.GetElementById('error_message').innerHTML = e;
	}
	rpc.post.on_result = function() {
		document.GetElementById
	}

	function restart()
	{
		rpc.get(message_count);
	}

	function send_data() {
		var kw = {
			url : "/chat/post",
			form : "theform"
		};
		dojo.xhrPost(kw);
		dojo.byId("message").value="";
		return false;
	}
	function read_data() {
		dojo.xhrGet( {
			url: "/chat/get/" + message_count,
			timeout: 10000,
			handleAs: "text",
			load: function(response, ioArgs) {
				dojo.byId("messages").innerHTML = response + '<br/>' + dojo.byId("messages").innerHTML;
				message_count++;
				read_data();
				return response;
			},
			error: function(response,ioArgs) {
				read_data();
				return response;
			}

		});
	}
	dojo.addOnLoad(read_data);
</script>
<form id="theform" >
	<input id="message" type="text" name="message" value="" />
	<input type="submit" value="Send" onclick="return send_data()"/>
</form>
<div id="messages">
</div>
</body>
